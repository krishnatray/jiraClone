{% extends 'base.html' %} {% block content %}
<h1>
  {{issue.title}}
  <span class="{{className}}">
    #{{issue.issue_no}}
  </span>
</h1>
<p class="font-weight-normal">{{issue.details|linebreaks}}</p>
<p class="font-weight-light">{{ issue.created_at }}</p>
<a
  class="btn btn-primary"
  role="button"
  href="{% url 'issues:edit' pk=issue.pk %}"
  >Edit</a
>
<a
  class="btn btn-danger"
  role="button"
  href="{% url 'issues:delete' pk=issue.pk %}"
  >Delete</a
>

<!-- Existing comments -->
{% include "issues/comment_list.html" %}

<!-- Comment Form for new comments -->
{% include "issues/comment_form.html" %} {% endblock %} {% block javascript %}

<script>
  // MSG: Comment POST
  $('#comment-form').submit(function (e) {
    e.preventDefault();
    $.ajax({
      type: 'POST',
      url: "{% url 'issues:detail' pk=issue.pk%}",
      data: {
        content: $('#content').val(),
        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
      },
      success: onCommentSuccess,
      error: function (response) {
        alert(response['error']);
      },
    });
  });

  function onCommentSuccess(response) {
    console.log(response);
    var user = JSON.parse(response['user']);
    // console.log(user);
    var fields = user[0]['fields'];
    $('#comment-form').trigger('reset');
    // Display content, username and created
    $('#comment-content').append(
      `<div id="comment-${response.id}">
        ${fields['username'] || ''}
        <span class="float-right">
        ${response.created || ''}
        </span>

        <div class="card">
          <div class="card-body">
            ${response.content || ''}
          </div>
        </div>
        <div class="mt-1 mb-4">
          <button class="btn btn-danger" id="delete-comment-${response.id}">Delete</button>
        </div>
      </div>`
    );
  }

  // MSG: Comment DELETE
  $(document).ready(function () {
    $('#comment-content').on('click', 'button[id^=delete-comment-]',function (e) {
      e.preventDefault();
      const comment_id = $(this).attr('id').split('-')[2];
      console.log(`Delete button clicked with id#${comment_id}`);
      $.ajax({
        type: 'DELETE',
        url: "{% url 'issues:detail' pk=issue.pk%}",
        beforeSend: function (xhr) {
          xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
        },
        data: {
          comment_pk: comment_id
        },
        success: function (json) {
          // hide the post
          console.log("Inside delete success");
          $('#comment-' + comment_id).hide(); // hide the post on success
          console.log("post deletion successful");
        },
        error: function (response) {
          // console.log(response);
          alert(response.statusText); // the message
        }
      })
    });
  });

  function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = jQuery.trim(cookies[i]);
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) == (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
</script>
{% endblock javascript %}
