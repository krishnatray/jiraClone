{% extends 'base.html' %} {% block content %}
<h1>
  {{issue.title}}
  <span class="{{className}}">
    #{{issue.issue_no}}
  </span>
</h1>
<p class="font-weight-normal">{{issue.details|linebreaks}}</p>
<p class="font-weight-light">{{ issue.created_at }}</p>
<a
  class="btn btn-primary"
  role="button"
  href="{% url 'issues:edit' pk=issue.pk %}"
  >Edit</a
>
<a
  class="btn btn-danger"
  role="button"
  href="{% url 'issues:delete' pk=issue.pk %}"
  >Delete</a
>

<!-- Existing comments -->

<h5 class="mt-3">Comments:</h5>
<div class="container" id="comment-content">
  {% for comment in comments %}
  <div class="card">
    <div class="card-body">
      {{ comment.content }}
    </div>
  </div>
  <p class="font-weight-light">
    {{ comment.user}}
    <span class="float-right">
      {{ comment.created }}
    </span>
  </p>
  {% endfor %}
</div>

<!-- Comment Form for new comments -->
<form method="post" id="comment-form" style="margin-top: 1.3em;">
  {% csrf_token %}
  <div class="form-group">
    <label for="content">New Comment</label>
    {{ comment_form.content }}
  </div>
  <button type="submit" class="btn btn-primary">Submit</button>
</form>

{% endblock %} 


{% block javascript %}
<script>
    /*
        On submiting the form, send the POST ajax
        request to server and after successfull submission
        display the object.
    */
  $("#comment-form").submit(function (e) {
    // preventing from page reload and default actions
    e.preventDefault();
        // serialize the data for sending the form data.
        var serializedData = $(this).serialize();
        // make POST ajax call
        $.ajax({
            type: 'POST',
            url: "{% url 'issues:detail' pk=issue.pk%}",
            data: serializedData,
            success: function (response) {
              // on successfull creating object
              // 1. clear the form.
              console.log(response);
              $("#comment-form").trigger('reset');
              // display the newly friend to table.
              var instance = JSON.parse(response["instance"]);
              var fields = instance[0]["fields"];
              $("#comment-content").prepend(
                `<div class="card">
                  <div class="card-body">
                    ${fields["content"]||""}
                  </div>
                </div>
                <p class="font-weight-light">
                  ${fields["user"]||""}
                  <span class="float-right">
                  ${fields["created"]||""}
                  </span>
                </p>`
                )
            },
            error: function (response) {
                // alert the error if any error occured
                alert(response["responseJSON"]["error"]);
            }
        })
  })
</script>
{% endblock javascript %}